<?php
/**
 * @file
 * Code for the Commons Radioactivity Groups feature.
 */

include_once 'commons_radioactivity_groups.features.inc';

/**
* Implements hook_node_insert().
*/
function commons_radioactivity_groups_node_insert($node) {
  // If there are no groups associated with this node
  // then there's nothing to do here.
  if (empty($node->og_group_ref) || !isset($node->field_radioactivity[LANGUAGE_NONE][0]['radioactivity_energy'])) {
    return;
  }
  commons_radioactivity_incident_groups($node, $node->field_radioactivity[LANGUAGE_NONE][0]['radioactivity_energy']);
}

/**
* Implements hook_node_update().
*/
function commons_radioactivity_groups_node_update($node) {
  // If there are no groups associated with this node
  // then there's nothing to do here.
  if (!isset($node->og_group_ref)) {
    return;
  }
  if ($node->og_group_ref !== $node->original->og_group_ref) {
    commons_radioactivity_process_node_group_membership_change($node);
  }
}

/**
 * Implements hook_default_page_manager_pages_alter().
 */
function commons_radioactivity_groups_default_page_manager_pages_alter(&$pages) {
  // Add the 'most active groups' block to the groups directory page.
  if (isset($pages['groups_directory'])) {
    $page = $pages['groups_directory'];
    $handler = $page->default_handlers['page_groups_directory_panel_context'];
    $display = $handler->conf['display'];

    $pane = new stdClass();
    $pane->pid = 'new-ab237aa5-5ae7-8fb4-e1ce-20c776a6950b';
    $pane->panel = 'two_66_33_second';
    $pane->type = 'views_panes';
    $pane->subtype = 'commons_radioactivity_groups_most_active-panel_pane_1';
    $pane->shown = TRUE;
    $pane->access = array();
    $pane->configuration = array();
    $pane->cache = array();
    $pane->style = array(
      'settings' => NULL,
    );
    $pane->css = array();
    $pane->extras = array();
    $pane->position = 0;
    $pane->locks = array();
    $pane->uuid = 'ab237aa5-5ae7-8fb4-e1ce-20c776a6950b';
    $display->content['new-ab237aa5-5ae7-8fb4-e1ce-20c776a6950b'] = $pane;
    $display->panels['two_66_33_second'][0] = 'new-ab237aa5-5ae7-8fb4-e1ce-20c776a6950b';
  }

  // Add the 'most active groups' block to the site homepage.
  if (isset($pages['commons_home'])) {
    $page = $pages['commons_home'];
    $handler = $page->default_handlers['page_commons_home_panel_context_2'];
    $display = $handler->conf['display'];

    $pane = new stdClass();
    $pane->pid = 'new-b6e290b7-1d2b-5db4-a181-28befdcde628';
    $pane->panel = 'three_33_second';
    $pane->type = 'views_panes';
    $pane->subtype = 'commons_radioactivity_groups_most_active-panel_pane_1';
    $pane->shown = TRUE;
    $pane->access = array();
    $pane->configuration = array();
    $pane->cache = array();
    $pane->style = array(
      'settings' => NULL,
    );
    $pane->css = array();
    $pane->extras = array();
    $pane->position = 0;
    $pane->locks = array();
    $pane->uuid = 'b6e290b7-1d2b-5db4-a181-28befdcde628';
    $display->content['new-b6e290b7-1d2b-5db4-a181-28befdcde628'] = $pane;
    $display->panels['three_33_second'][0] = 'new-b6e290b7-1d2b-5db4-a181-28befdcde628';
  }
}

/**
 * Implements hook_panelizer_defaults_alter().
 */
function commons_radioactivity_groups_panelizer_defaults_alter(&$panelizers) {
  // Add the 'active in group' block to each group node.
  $group_bundles = og_get_all_group_bundle();

  if (!empty($group_bundles['node'])) {
    foreach ($group_bundles['node'] as $bundle => $name) {
      if (isset($panelizers["node:$bundle:default"])) {
        $panelizer = $panelizers["node:$bundle:default"];
        $display = $panelizer->display;

        $pane = new stdClass();
        $pane->pid = 'new-ba735f2b-4734-7724-098d-1925c6a4bb47';
        $pane->panel = 'two_66_33_second';
        $pane->type = 'views_panes';
        $pane->subtype = 'commons_radioactivity_groups_active_in_group-panel_pane_1';
        $pane->shown = TRUE;
        $pane->access = array();
        $pane->configuration = array(
          'arguments' => array(
            'gid' => '%node:nid',
          ),
          'context' => array(
            0 => 'panelizer',
          ),
        );
        $pane->cache = array();
        $pane->style = array(
          'settings' => NULL,
        );
        $pane->css = array();
        $pane->extras = array();
        $pane->position = 2;
        $pane->locks = array();
        $pane->uuid = 'ba735f2b-4734-7724-098d-1925c6a4bb47';
        $display->content['new-ba735f2b-4734-7724-098d-1925c6a4bb47'] = $pane;
        $display->panels['two_66_33_second'][2] = 'new-ba735f2b-4734-7724-098d-1925c6a4bb47';
      }
    }
  }
}
